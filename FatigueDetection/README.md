## åŸºäºyolov5+rv1126çš„é©¾é©¶å‘˜ç–²åŠ³æ£€æµ‹ç»ˆç«¯

#### 1.Yolov5ç®€ä»‹

**å®æ—¶æ€§   ä½èµ„æºæ¶ˆè€—    é«˜æ•ˆæ€§   ç«¯åˆ°ç«¯    å¤šä»»åŠ¡å­¦ä¹ **

yolov5æºç è·¯å¾„ï¼š[ultralytics/yolov5: YOLOv5 ğŸš€ in PyTorch > ONNX > CoreML > TFLite (github.com)](https://github.com/ultralytics/yolov5)

![yolov5](README.assets/yolov5.png)

ï¼ˆ1ï¼‰è¾“å…¥ç«¯ï¼šMosaicæ•°æ®å¢å¼ºã€è‡ªé€‚åº”ææ¡†è®¡ç®—ã€è‡ªé€‚åº”å›¾ç‰‡ç¼©æ”¾

ï¼ˆ2ï¼‰Backboneï¼šFocusï¼ˆå›¾ç‰‡è¿›å…¥backboneå‰ï¼Œå¯¹å›¾ç‰‡è¿›è¡Œåˆ‡ç‰‡æ“ä½œï¼Œåœ¨æ¯ä¸€å¼ å›¾ç‰‡ä¸­æ¯éš”ä¸€ä¸ªåƒç´ æ‹¿åˆ°ä¸€ä¸ªå€¼å†è¿›è¡Œå·ç§¯æ“ä½œï¼‰ã€CBLç»“æ„ï¼ˆç”±Conv+Bn+Leaky+reluç»„æˆï¼‰CSPç»“æ„ï¼ˆåˆ†ä¸ºCSP1_Xå’ŒCSP2_Xï¼‰

ï¼ˆ3ï¼‰Neckï¼šFPN+PANç»“æ„

ï¼ˆ4ï¼‰Headï¼šCIOU_Loss

Mosaicæ•°æ®å¢å¼ºï¼šYOLOv5è¾“å…¥ç«¯é‡‡ç”¨Mosaicæ•°æ®å¢å¼ºï¼ŒMosaicæ•°æ®å¢å¼ºç®—æ³•å°†å¤šå¼ å›¾ç‰‡æŒ‰ç…§ä¸€å®šæ¯”ä¾‹ç»„åˆæˆä¸€å¼ å›¾ç‰‡ï¼Œä½¿æ¨¡å‹åœ¨æ›´å°çš„èŒƒå›´å†…è¯†åˆ«ç›®æ ‡

è‡ªé€‚åº”ææ¡†è®¡ç®—ï¼šä½¿ç”¨å•ç‹¬çš„è„šæœ¬è¿›è¡Œåˆå§‹ææ¡†è®¡ç®—

è‡ªé€‚åº”å›¾ç‰‡ç¼©æ”¾ï¼šç¡®å®šç¼©æ”¾æ¯”ä¾‹->è®¡ç®—å¥½ç¼©æ”¾åçš„å›¾ç‰‡å¤§å°->è®¡ç®—é»‘è¾¹å¡«å……æ•°å€¼

NMSéæå¤§å€¼æŠ‘åˆ¶ï¼šNMSæœ¬è´¨ä¸Šæ˜¯æœç´¢å±€éƒ¨æå¤§å€¼ï¼ŒæŠ‘åˆ¶éæå¤§å€¼å…ƒç´ ï¼Œå³æŠ‘åˆ¶æ£€æµ‹æ—¶å†—ä½™çš„æ¡†

#### 2.Linuxç³»ç»Ÿç§»æ¤

**RV1126æ‰©å±•åº“     uboot       Linux kernel        æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆrooftsï¼‰**

##### 2.1 U-Bootç§»æ¤

U-Bootç”¨äºå¼•å¯¼Linuxç³»ç»Ÿï¼Œåˆå§‹åŒ–DDRå¤–è®¾ï¼Œå°†Linuxå†…æ ¸ä»flashæ‹·è´åˆ°DDRè¿è¡Œ

U-Bootå¯åŠ¨æµç¨‹ï¼š

å…¥å£ç¨‹åºï¼šu-boot.lds è¯¥ä»£ç çš„å…¥å£ç‚¹ï¼š___start   è¯¥æ–‡ä»¶åœ¨arch/arm/lib/ectors.Sä¸­æœ‰å®šä¹‰ï¼Œè®¾ç½®äº†ä¸­æ–­å‘é‡è¡¨ï¼›image_copy_startå­˜æ”¾åœ¨0x87800000;è¿›å…¥åˆ°resetå‡½æ•°ä¸­-->save_boot_paramså‡½æ•°ï¼Œå®šä¹‰åœ¨start.Sé‡Œ--->save_boot_params_setå‡½æ•°ï¼šè¯»å–cpsrä¸­å¯„å­˜å™¨ï¼Œä¿å­˜åˆ°r0ä¸­ï¼Œå°†r0çš„å€¼ä¸0X1Fè¿›è¡Œè¿ç®—ï¼Œç»“æœä¿å­˜åˆ°r1ä¸­ï¼Œç›®çš„æ˜¯å–cpsrçš„bit0~bit4ï¼Œè¿™5ä½M[4:0]ç”¨æ¥è®¾ç½®å¤„ç†å™¨çš„å·¥ä½œæ¨¡å¼ --- >è¯»å–CP15ä¸­c1å¯„å­˜å™¨çš„å€¼åˆ°r0å¯„å­˜å™¨ä¸­ï¼Œæ¸…é™¤SCTLRå¯„å­˜å™¨ä¸­çš„bit13ï¼Œè¯¥ä½æ˜¯å‘é‡è¡¨æ§åˆ¶ä½ï¼Œ0ä»£è¡¨å‘é‡è¡¨åŸºåœ°å€ä¸º0X00000000ï¼Œè½¯ä»¶å¯ä»¥é‡å®šä½å‘é‡è¡¨ï¼Œ1ä»£è¡¨åŸºåœ°å€ä¸º0XFFFF0000ï¼Œè½¯ä»¶ä¸èƒ½é‡å®šä½ï¼›å°†r0å€¼å†™å…¥å¯„å­˜å™¨SCTLRä¸­ï¼›è®¾ç½®r0å€¼ä½â€”startï¼Œâ€”startå°±æ˜¯æ•´ä¸ªubootçš„å…¥å£åœ°å€0X87800000ï¼Œä¹Ÿæ˜¯å‘é‡è¡¨çš„èµ·å§‹åœ°å€ï¼›å°†r0å€¼å†™å…¥åˆ°CP15çš„c12å¯„å­˜å™¨ä¸­ï¼Œä¹Ÿå°±æ˜¯VBARå¯„å­˜å™¨ï¼Œè®¾ç½®å‘é‡è¡¨é‡å®šä½çš„ï¼›---->cpu_init_cp15å‡½æ•°ç”¨æ¥è®¾ç½®CP15ç›¸å…³å†…å®¹ï¼Œæ¯”å¦‚å…³é—­MMU...---->cpu_init_critå‡½æ•°è°ƒç”¨low_level_initå‡½æ•°---->s_initå‡½æ•°ï¼Œåˆ¤æ–­CPUç±»å‹ï¼Œå¯¹äºI.MX6ULæ¥è¯´ï¼Œå°±æ˜¯ä¸ªç©ºå‡½æ•°---->è¿›å…¥mainå‡½æ•°,è®¾ç½®SPæŒ‡é’ˆä¸ºCONFIG_SYS_INIT_SP_ADDRï¼ˆ0X0091FF00ï¼‰ï¼Œspåš8å­—èŠ‚å¯¹é½ï¼Œè¯»å–spåˆ°å¯„å­˜å™¨r0é‡Œé¢ï¼Œr0=0X0091FF00ï¼Œè°ƒç”¨board_init_f_alloc_reserveï¼Œæ­¤å‡½æ•°æœ‰ä¸€ä¸ªå‚æ•°ï¼Œå‚æ•°ä¸ºr0çš„å€¼ï¼ˆ0X0091FF00ï¼‰ï¼Œè¯¥å‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯ç•™å‡ºæ—©æœŸçš„mallocåŒºåŸŸå’Œgdå†…å­˜åŒºåŸŸ----->board_int_få‡½æ•°ï¼šåˆå§‹åŒ–å¤–è®¾ï¼Œæ¯”å¦‚ä¸²å£ã€å®šæ—¶å™¨ï¼Œæˆ–è€…æ‰“å°ä¸€äº›æ¶ˆæ¯ç­‰ and åˆå§‹åŒ–gdçš„å„ä¸ªæˆå‘˜å˜é‡ï¼Œubootä¼šå°†è‡ªå·±é‡å®šä½åˆ°DRAMæœ€åé¢åœ°å€åŒºåŸŸï¼Œä¹Ÿå°±æ˜¯å°†è‡ªå·±æ‹·è´åˆ°DRAMæœ€åé¢çš„å†…å­˜åŒºåŸŸï¼Œç›®çš„æ˜¯ä¸ºäº†ç»™Linuxè…¾å‡ºç©ºé—´ï¼›---->relocate_codeå‡½æ•°ç”¨äºä»£ç æ‹·è´çš„ï¼Œubootå¯¹äºé‡å®šä½åé“¾æ¥åœ°å€å’Œè¿è¡Œåœ°å€ä¸ä¸€è‡´çš„è§£å†³åŠæ³•å°±æ˜¯é‡‡ç”¨ä½ç½®æ— å…³ç ----->relocate_vectorså‡½æ•°ç”¨äºé‡å®šä½å‘é‡è¡¨çš„---->board_init_rå‡½æ•°ï¼šå‰é¢çš„board_init_få‡½æ•°å¹¶æ²¡æœ‰åˆå§‹åŒ–æ‰€æœ‰çš„å¤–è®¾ï¼Œè€Œboard_init_ræ¥å®Œæˆåç»­å·¥ä½œçš„----->è¿›å…¥åˆ°run_main_loopå‡½æ•°ï¼šubootå¯åŠ¨åä¼šè¿›å…¥3så€’è®¡æ—¶ï¼Œå¦‚æœåœ¨3så€’è®¡æ—¶ä¹‹å‰æŒ‰ä¸‹å›è½¦é”®ï¼Œå°±ä¼šè¿›å…¥ubootå‘½ä»¤æ¨¡å¼ï¼Œå¦è€…å°±å¯åŠ¨Linuxå†…æ ¸ï¼Œè¯¥åŠŸèƒ½å°±æ˜¯ç”±run_main_loopå‡½æ•°å®Œæˆçš„ï¼Œé‡Œé¢çš„cli_loopå‡½æ•°æ˜¯å‘½ä»¤æ¨¡å¼ä¸‹ï¼Œå¤„ç†å„ç§å‘½ä»¤æ“ä½œçš„ï¼Œé‡Œé¢è°ƒç”¨çš„æ˜¯parse_stream_outerå‡½æ•°çš„---->å¯åŠ¨å†…æ ¸è¿‡ç¨‹ï¼šåœ¨å¯åŠ¨Linuxå†…æ ¸çš„æ—¶å€™éƒ½ä¼šç”¨åˆ°ä¸€ä¸ªé‡è¦çš„å…¨å±€å˜é‡imagesï¼Œé‡Œé¢åŒ…å«äº†ç³»ç»Ÿé•œåƒçš„ä¿¡æ¯----->do_bootzå‡½æ•°---->bootz_startå‡½æ•°---->bootz_setupå‡½æ•°   ä»do_bootzå‡½æ•°åç»§ç»­è°ƒç”¨bootm-find_imageså‡½æ•°ï¼Œdo_bootm_stateså‡½æ•°---->bootm_os_get_boot_funcå‡½æ•°----->do_bootm_linuxå‡½æ•°---->boot_jump_linuxå‡½æ•°----->æœ€åè¿›å…¥kernel_entry(0, machid, r2)å¯åŠ¨å†…æ ¸ï¼›zero:0ï¼Œmachid:æœºå™¨IDï¼Œr2:ATAGSæˆ–è€…è®¾å¤‡æ ‘ï¼ˆDTBï¼‰é¦–åœ°å€

æœ€ç»ˆçš„å†…å­˜åˆ†é…å›¾ï¼š

![ubootmem](README.assets/ubootmem.png)

bootzå‘½ä»¤çš„å†…æ ¸å¯åŠ¨æµç¨‹å¦‚ä¸‹ï¼š

![bootz](README.assets/bootz.png)

##### 2.2Linuxå†…æ ¸ç§»æ¤

**å†…å­˜ç®¡ç†  è¿›ç¨‹ç®¡ç† è°ƒåº¦ç®—æ³•  æ–‡ä»¶ç³»ç»Ÿ  è®¾å¤‡ç®¡ç†  ç½‘ç»œç³»ç»Ÿ**

å¤šä¸ªç¨‹åºè¿è¡Œåœ¨å†…å­˜ä¸­ï¼Œéœ€è¦å°†ä»–ä»¬è®¿é—®çš„åœ°å€éš”ç¦»å¼€æ¥ï¼Œå› æ­¤éœ€è¦è™šæ‹Ÿå†…å­˜ç³»ç»Ÿï¼Œå°†ä¸åŒè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€å’Œä¸åŒå†…å­˜çš„ç‰©ç†åœ°å€æ˜ å°„èµ·æ¥ï¼Œå…¶ä¸­çš„æ˜ å°„æ˜¯ä½¿ç”¨MMUå†…å­˜ç®¡ç†å•å…ƒæ¥å®ç°çš„ã€‚ä¸ºä¿è¯æœ‰åºç»„ç»‡å†…å­˜ä¸­çš„æ•°æ®ï¼Œå°†**å†…å­˜åˆ†æ®µ**ï¼šä»£ç æ®µã€æ•°æ®æ®µã€æ ˆæ®µã€å †æ®µï¼Œä½†ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡å’Œå†…å­˜äº¤æ¢æ•ˆç‡ä½é—®é¢˜ï¼Œå†…å­˜ç¢ç‰‡åˆ†ä¸ºå†…éƒ¨å†…å­˜ç¢ç‰‡å’Œå¤–éƒ¨å†…å­˜ç¢ç‰‡ï¼Œè¿™ç§æ–¹å¼ä¼šå‡ºç°å¤–éƒ¨å†…å­˜ç¢ç‰‡é—®é¢˜ï¼Œè§£å†³çš„åŠæ³•å°±æ˜¯å†…å­˜äº¤æ¢ï¼Œå°†ç‰©ç†å†…å­˜ä¸­çš„éƒ¨åˆ†äº¤æ¢åˆ°ç£ç›˜ä¸Šï¼Œä»¥é‡Šæ”¾ç‰©ç†å†…å­˜ç©ºé—´ä¾›å…¶å®ƒç¨‹åºæˆ–è¿›ç¨‹ä½¿ç”¨çš„è¿‡ç¨‹ï¼Œç”±äºè¿™ä¸€è¿‡ç¨‹å¯¹ç£ç›˜çš„è®¿é—®é€Ÿåº¦è¾ƒæ…¢å°±æ˜¯æ˜¾å¾—å¾ˆå¡é¡¿ã€‚åˆ†æ®µçš„å¥½å¤„å¯ä»¥äº§ç”Ÿè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œä½†ä¼šå‡ºç°ä»¥ä¸Šé—®é¢˜ï¼Œå› æ­¤å‡ºç°äº†**å†…å­˜åˆ†é¡µ**ï¼Œåˆ†é¡µæ˜¯æŠŠæ•´ä¸ªè™šæ‹Ÿå’Œç‰©ç†å†…å­˜ç©ºé—´åˆ‡åˆ†æˆä¸€æ®µæ®µå›ºå®šå°ºå¯¸çš„å¤§å°ï¼Œå«é¡µï¼ŒLinuxä¸‹ï¼Œä¸€é¡µå 4KBã€‚ç”±äºå†…å­˜åˆ†é¡µæœºåˆ¶åˆ†é…çš„å†…å­˜æœ€å°å•ä½æ˜¯ä¸€é¡µï¼Œå³ä½¿ç¨‹åºä¸è¶³ä¸€é¡µå¤§å°ï¼Œä¹Ÿæ™ºèƒ½åˆ†é…ä¸€é¡µï¼Œè¿™ä¼šé€ æˆå†…éƒ¨å†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼Œå¦‚æœå†…å­˜ä¸å¤Ÿåˆ†é…çš„ä¼šå°†[æœ€è¿‘æ²¡è¢«ä½¿ç”¨]çš„é¡µé¢æ¢å‡ºåˆ°ç¡¬ç›˜ä¸Šï¼ˆä¸éœ€è¦æŠŠæ•´ä¸ªç¨‹åºéƒ½åŠ è½½åˆ°å†…å­˜ä¸­ï¼‰ï¼Œå¾…éœ€è¦æ—¶ï¼Œå†æ¢å…¥åˆ°å†…å­˜ä¸­ï¼Œä¸ºäº†è§£å†³äº§ç”Ÿçš„é¡µè¡¨è¿‡å¤§çš„é—®é¢˜ï¼Œå°±æœ‰äº†å¤šçº§é¡µè¡¨

å†…å­˜åˆ†ä¸ºï¼šå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´

ç”¨æˆ·ç©ºé—´ï¼šä»£ç æ®µï¼šåŒ…æ‹¬äºŒè¿›åˆ¶å¯æ‰§è¡Œä»£ç    æ•°æ®æ®µï¼šåŒ…æ‹¬å·²åˆå§‹åŒ–çš„é™æ€å¸¸é‡å’Œå…¨å±€å˜é‡  BSSæ®µï¼šåŒ…æ‹¬æœªåˆå§‹åŒ–é™æ€å¸¸é‡å’Œå…¨å±€å˜é‡  å †æ®µï¼šåŒ…æ‹¬åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼Œå‘ä¸Šå¢é•¿  æ–‡ä»¶æ˜ å°„æ®µï¼šåŒ…æ‹¬åŠ¨æ€åº“ã€å…±äº«å†…å­˜ç­‰ï¼Œå‘ä¸Šå¢é•¿  æ ˆæ®µï¼šåŒ…æ‹¬å±€éƒ¨å˜é‡å’Œå‡½æ•°è°ƒç”¨çš„ä¸Šä¸‹æ–‡ç­‰ã€‚æ ˆçš„å¤§å°ä¸€èˆ¬æ˜¯8MB

æ¯ä¸ªè¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸èƒ½ç›¸äº’è®¿é—®ï¼Œå°±éœ€è¦IPCæœºåˆ¶ï¼š{ç®¡é“ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼Œå…±äº«å†…å­˜ï¼Œä¿¡å·é‡}ã€‚å¤šä¸ªçº¿ç¨‹ç«äº‰åŒä¸€ä¸ªèµ„æºæ—¶ä¼šå¯¼è‡´æ•°æ®é”™ä¹±ï¼Œè¿™æ—¶éœ€è¦äº’æ–¥æœºåˆ¶ï¼Œæ¥ä¿è¯å¯¹ä¸´ç•ŒåŒºèµ„æºè®¿é—®é—®é¢˜ã€‚åœ¨ç”Ÿäº§è€…-æ¶ˆè´¹è€…çº¿ç¨‹æ¨¡å‹ä¸­ï¼Œè¿˜éœ€è¦ä¿è¯åŒæ­¥ï¼Œå°±æ˜¯å¹¶å‘çš„è¿›ç¨‹/çº¿ç¨‹åœ¨ä¸€äº›å…³é”®ç‚¹éœ€è¦äº’ç›¸ç­‰å¾…ä¸äº’é€šæ¶ˆæ¯ã€‚å½“ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ï¼Œå°±ä¼šå¯¼è‡´{æ­»é”}é—®é¢˜ã€‚å„ç§é”éƒ½æ˜¯åŸºäºäº’æ–¥é”å’Œè‡ªæ—‹é”çš„ï¼Œäº’æ–¥é”åŠ é”å¤±è´¥åï¼Œçº¿ç¨‹ä¼šé‡Šæ”¾CPUï¼Œç»™å…¶å®ƒè¿›ç¨‹ï¼Œè‡ªæ—‹é”åŠ é”å¤±è´¥åï¼Œçº¿ç¨‹ä¼šå¿™ç­‰å¾…ï¼ŒçŸ¥é“è·å–åˆ°é”

è°ƒåº¦ç®—æ³•ï¼šlinuxç³»ç»Ÿä¸‰å¤§è°ƒåº¦æœºåˆ¶ï¼šè¿›ç¨‹è°ƒåº¦/é¡µé¢è°ƒåº¦/ç£ç›˜è°ƒåº¦ç®—æ³•

è¿›ç¨‹è°ƒåº¦ç®—æ³•ï¼šå…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦ç®—æ³•ï¼Œæœ€çŸ­ä½œä¸šä¼˜å…ˆè°ƒåº¦ç®—æ³•ï¼Œé«˜å“åº”æ¯”ä¼˜å…ˆè°ƒåº¦ç®—æ³•ï¼Œæ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ç®—æ³•ï¼Œæœ€é«˜ä¼˜å…ˆçº§è°ƒåº¦ç®—æ³•ï¼Œå¤šçº§åé¦ˆé˜Ÿåˆ—è°ƒåº¦ç®—æ³•

å†…å­˜é¡µé¢ç½®æ¢ç®—æ³•ï¼šå½“CPUè®¿é—®é¡µé¢ä¸åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªç¼ºé¡µä¸­æ–­ï¼Œè¯·æ±‚æ“ä½œç³»ç»Ÿå°†æ‰€ç¼ºé¡µè°ƒå…¥åˆ°ç‰©ç†å†…å­˜ä¸­ï¼Œå½“å‡ºç°ç¼ºé¡µä¸­æ–­æ—¶ï¼Œéœ€è°ƒå…¥æ–°é¡µé¢è€Œå†…å­˜å·²æ»¡æ—¶ï¼Œé€‰æ‹©è¢«ç½®æ¢çš„ç‰©ç†é¡µé¢ï¼šæœ€ä½³é¡µé¢ç½®æ¢ç®—æ³•ï¼Œå…ˆè¿›å…ˆå‡ºç½®æ¢ç®—æ³•ï¼Œæœ€è¿‘æœ€ä¹…æœªä½¿ç”¨çš„ç½®æ¢ç®—æ³•ï¼Œæ—¶é’Ÿé¡µé¢ç½®æ¢ç®—æ³•ï¼Œæœ€ä¸å¸¸ç”¨ç®—æ³•ã€‚

ç£ç›˜è°ƒåº¦ç®—æ³•ï¼šç•¥ç•¥ç•¥

Linuxå†…æ ¸å¯åŠ¨æµç¨‹ï¼švmlinux.ldsï¼ˆENTRY(stext)ï¼‰æ˜¯å†…æ ¸çš„å…¥å£åœ°å€ï¼Œç¡®ä¿CPUå¤„äºSVCæ¨¡å¼ï¼Œå…³é—­æ‰€æœ‰ä¸­æ–­ï¼Œè·å–CPU ID---->_mmap_switchedå‡½æ•°---->start_kernelæ¥å¯åŠ¨å†…æ ¸ï¼Œè¯¥å‡½æ•°æ¯ä¸€ä¸ªéƒ½æ˜¯ä¸€ä¸ªåºå¤§çš„çŸ¥è¯†ç‚¹----->reset_init()å‡½æ•°ï¼Œå¯åŠ¨RCUé”è°ƒåº¦å™¨ï¼Œè°ƒç”¨å‡½æ•°kernel_threadåˆ›å»ºkernel_initè¿›ç¨‹ï¼Œinitè¿›ç¨‹çš„PIDä¸º1ï¼Œinitè¿›ç¨‹ä¸€å¼€å§‹æ˜¯å†…æ ¸è¿›ç¨‹ï¼Œåé¢initè¿›ç¨‹ä¼šåœ¨æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­æŸ¥æ‰¾åä¸º"init"ç¨‹åºè¿è¡Œï¼Œå†åˆ›å»ºkthreaddå†…æ ¸è¿›ç¨‹ï¼Œæ­¤å†…æ ¸è¿›ç¨‹çš„PIDä¸º2ï¼Œè´Ÿè´£æ‰€æœ‰å†…æ ¸è¿›ç¨‹çš„è°ƒåº¦å’Œç®¡ç†

##### 2.3 æ ¹æ–‡ä»¶ç³»ç»Ÿç§»æ¤

å†…æ ¸å¯åŠ¨æŒ‚è½½çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œä½¿ç”¨busyBoxæ„å»º

**æ–‡ä»¶ç³»ç»Ÿï¼š**æ˜¯æ“ä½œç³»ç»Ÿè´Ÿè´£ç®¡ç†æŒä¹…æ•°æ®çš„å­ç³»ç»Ÿï¼ŒLinuxä¸€åˆ‡çš†æ–‡ä»¶ï¼ŒLinuxæ–‡ä»¶ç³»ç»Ÿä¼šä¸ºæ¯ä¸ªæ–‡ä»¶åˆ†é…ä¸¤ä¸ªæ•°æ®ç»“æ„ï¼šç´¢å¼•èŠ‚ç‚¹å’Œç›®å½•é¡¹ï¼Œï¼Œç´¢å¼•èŠ‚ç‚¹inodeç”¨æ¥è®°å½•æ–‡ä»¶çš„å…ƒä¿¡æ¯ã€‚å¦‚inodeç¼–å·ï¼Œæ–‡ä»¶å¤§å°ï¼Œè®¿é—®æƒé™ï¼Œåˆ›å»ºæ—¶é—´ï¼Œä¿®æ”¹æ—¶é—´ï¼Œæ•°æ®åœ¨ç£ç›˜çš„ä½ç½®ç­‰ç­‰ï¼Œç´¢å¼•èŠ‚ç‚¹æ˜¯æ–‡ä»¶çš„å”¯ä¸€æ ‡è¯†ï¼Œä¸€ä¸€å¯¹åº”çš„ï¼›ç›®å½•é¡¹dentryç”¨æ¥è®°å½•æ–‡ä»¶çš„åå­—ã€ç´¢å¼•èŠ‚ç‚¹æŒ‡é’ˆï¼Œæ˜¯ç”±å†…æ ¸ç»´æŠ¤çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå­˜æ”¾åœ¨å†…å­˜ï¼Œç›®å½•é¡¹å’Œæ‰€ä»¥èŠ‚ç‚¹çš„å…³ç³»å¯ä»¥æ˜¯å¤šå¯¹ä¸€çš„ï¼Œä¸€ä¸ªæ–‡ä»¶å¯ä»¥æœ‰å¤šä¸ªåˆ«åï¼Œç¡¬é“¾æ¥çš„å®ç°å°±æ˜¯å¤šä¸ªç›®å½•é¡¹ä¸­çš„ç´¢å¼•èŠ‚ç‚¹æŒ‡å‘åŒä¸€ä¸ªæ–‡ä»¶ã€‚æ–‡ä»¶ç³»ç»Ÿç§ç±»ç¹å¤šï¼Œè€Œæ“ä½œç³»ç»Ÿå¸Œæœ›å¯¹ç”¨æˆ·æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ï¼Œäºæ˜¯åœ¨ç³»ç»Ÿè°ƒç”¨å’Œæ–‡ä»¶ç³»ç»Ÿå¼•å…¥è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿè¿™ä¸€ä¸­é—´å±‚ï¼Œæ–‡ä»¶ç³»ç»Ÿé¦–å…ˆè¦æŒ‚è½½åˆ°æŸä¸ªç›®å½•æ‰å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œæ¯”å¦‚Linuxç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œä¼šæŠŠæ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°æ ¹ç›®å½•ã€‚å½“æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶åï¼Œæ“ä½œç³»ç»Ÿä¼šè·Ÿè¸ªè¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶ï¼Œæ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹ç»´æŠ¤ä¸€ä¸ªæ‰“å¼€æ–‡ä»¶è¡¨ï¼Œæ–‡ä»¶è¡¨é‡Œçš„æ¯ä¸€é¡¹ä»£è¡¨ã€æ–‡ä»¶æè¿°ç¬¦ã€‘ï¼Œæ‰€ä»¥è¯´æ–‡ä»¶æè¿°ç¬¦æ˜¯æ‰“å¼€æ–‡ä»¶çš„æ ‡è¯†ã€‚æ–‡ä»¶ç³»ç»Ÿçš„é‡è¦åŠŸèƒ½å°±æ˜¯å°†æ–‡ä»¶æ•°æ®å’Œç£ç›˜å—å¯¹åº”èµ·æ¥ï¼Œæ•°æ®åœ¨ç£ç›˜çš„å­˜æ”¾æ–¹å¼åˆ†ä¸ºï¼šè¿ç»­ç©ºé—´å­˜æ”¾æ–¹å¼å’Œéè¿ç»­ç©ºé—´å­˜æ”¾æ–¹å¼ï¼Œéè¿ç»­ç©ºé—´å­˜æ”¾æ–¹å¼åˆå¯åˆ†ä¸ºé“¾è¡¨æ–¹å¼å’Œç´¢å¼•æ–¹å¼ï¼šè¿ç»­ç©ºé—´å­˜æ”¾æ–¹å¼æ–‡ä»¶å¤´éœ€è¦å­˜æ”¾èµ·å§‹å—ä½ç½®å’Œé•¿åº¦ï¼Œè¯»å†™æ•ˆç‡é«˜ï¼Œä½†ä¼šäº§ç”Ÿç£ç›˜ç©ºé—´ç¢ç‰‡å’Œæ–‡ä»¶é•¿åº¦ä¸æ˜“æ‰©å¼ çš„ç¼ºé™·ã€‚éè¿ç»­å­˜æ”¾æ–¹å¼ä¸­çš„é“¾è¡¨æ–¹å¼åˆåˆ†ä¸ºï¼šéšå¼é“¾è¡¨å’Œæ˜¾å¼é“¾è¡¨ï¼Œéšå¼é“¾è¡¨å­˜æ”¾æ–¹å¼çš„æ–‡ä»¶å¤´è¦åŒ…å«ç¬¬ä¸€å—å’Œæœ€åä¸€å—çš„ä½ç½®ï¼Œæ¯ä¸ªæ•°æ®å—è¿˜è¦ç•™å‡ºä¸€ä¸ªæŒ‡é’ˆç©ºé—´ç”¨äºå­˜æ”¾ä¸‹ä¸€ä¸ªæ•°æ®å—çš„ä½ç½®ï¼Œè¿™ç§çš„ç¼ºç‚¹å°±æ˜¯æ™ºèƒ½é¡ºåºè®¿é—®æ–‡ä»¶ï¼Œæ— æ³•éšæœºè®¿é—®ï¼Œä»¥åŠæ•°æ®å—æŒ‡é’ˆæ¶ˆè€—äº†ä¸€å®šçš„å­˜å‚¨ç©ºé—´ï¼›å¦‚æœå°†æ¯ä¸ªç£ç›˜å—çš„æŒ‡é’ˆï¼Œå§å®ƒä»¬æ”¾åœ¨å†…å­˜çš„ä¸€ä¸ªè¡¨(FATæ–‡ä»¶åˆ†é…è¡¨)ä¸­ï¼Œè¿™å°±å«æ˜¾ç¤ºé“¾æ¥ï¼Œè¯¥è¡¨åœ¨æ•´ä¸ªç£ç›˜ä»…è®¾ç½®ä¸€å¼ ï¼Œæ¯ä¸ªè¡¨é¡¹ä¸­å­˜æ”¾é“¾æ¥æŒ‡é’ˆï¼ŒæŒ‡å‘ä¸‹ä¸€ä¸ªæ•°æ®å—å·ï¼›ç´¢å¼•æ–¹å¼ï¼šä¸ºæ¯ä¸ªæ–‡ä»¶åˆ›å»ºä¸€ä¸ªã€ç´¢å¼•æ•°æ®å—ã€‘ï¼Œé‡Œé¢å­˜æ”¾çš„æ˜¯æŒ‡å‘æ–‡ä»¶æ•°æ®å—çš„æŒ‡é’ˆåˆ—è¡¨ï¼Œæ–‡ä»¶å¤´è¿˜éœ€è¦åŒ…å«æŒ‡å‘ç´¢å¼•æ•°æ®å—çš„æŒ‡é’ˆï¼Œè¿™å°±å¯ä»¥é€šè¿‡æ–‡ä»¶å¤´å¾—åˆ°ç´¢å¼•æ•°æ®å—çš„ä½ç½®ã€‚

![å¤šçº§ç´¢å¼•å—](README.assets/%E5%A4%9A%E7%BA%A7%E7%B4%A2%E5%BC%95%E5%9D%97.png)

ä½å›¾æ³•ç®¡ç†ç©ºé—²ç©ºé—´0110101001010111100101

è½¯é“¾æ¥å’Œç¡¬é“¾æ¥ï¼šç¡¬é“¾æ¥æ˜¯å¤šä¸ªç›®å½•é¡¹ä¸­çš„ã€ç´¢å¼•èŠ‚ç‚¹ã€‘æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯æŒ‡å‘åŒä¸€ä¸ªinodeï¼›è½¯é“¾æ¥ç›¸å½“äºé‡æ–°åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶æœ‰ç‹¬ç«‹çš„inodeï¼Œä½†æ˜¯è¿™ä¸ªæ–‡ä»¶çš„å†…å®¹æ˜¯å¦å¤–æ–‡ä»¶çš„è·¯å¾„ï¼Œæ‰€ä»¥è®¿é—®è½¯é“¾æ¥æ—¶ï¼Œå®é™…ä¸Šæ˜¯è®¿é—®åˆ°äº†å¦ä¸€ä¸ªæ–‡ä»¶ï¼Œæ˜¯å¯ä»¥è·¨æ–‡ä»¶ç³»ç»Ÿçš„ã€‚

**æ–‡ä»¶I/O**

ç¼“å†²ä¸éç¼“å†²I/O  ç›´æ¥ä¸éç›´æ¥I/O  é˜»å¡å’Œéé˜»å¡I/O   åŒæ­¥å’Œå¼‚æ­¥I/O

ç¼“å†²I/Oï¼Œåˆ©ç”¨çš„æ˜¯æ ‡å‡†åº“çš„ç¼“å­˜å®ç°æ–‡ä»¶çš„åŠ é€Ÿè®¿é—®ï¼Œè€Œæ ‡å‡†åº“å†é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—®æ–‡ä»¶ï¼›éç¼“å†²I/Oï¼Œç›´æ¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨è®¿é—®æ–‡ä»¶ï¼Œä¸ç»è¿‡æ ‡å‡†åº“ç¼“å­˜ï¼Œè¿™ä¸¤è€…çš„å·®åˆ«å°±æ˜¯æ˜¯å¦ä½¿ç”¨äº†æ ‡å‡†åº“ä¸­çš„ã€ç¼“å†²ã€‘ã€‚åŒç†ï¼Œæ ¹æ®æ˜¯å¦åˆ©ç”¨æ“ä½œç³»ç»Ÿçš„ç¼“å­˜ï¼Œå¯ä»¥æŠŠæ–‡ä»¶I/Oåˆ†ä¸ºç›´æ¥I/Oå’Œéç›´æ¥I/Oï¼Œç›´æ¥I/Oï¼Œä¸ä¼šå‘ç”Ÿå†…æ ¸ç¼“å­˜å’Œç”¨æˆ·ç¨‹åºä¹‹é—´æ•°æ®å¤åˆ¶ï¼Œè€Œæ˜¯ç›´æ¥ç»è¿‡æ–‡ä»¶ç³»ç»Ÿè®¿é—®ç£ç›˜ï¼Œéç›´æ¥I/Oï¼Œè¯»æ“ä½œæ—¶ï¼Œæ•°æ®ä»å†…æ ¸ç¼“å­˜ä¸­æ‹·è´ç»™ç”¨æˆ·ç¨‹åºï¼Œå†™æ“ä½œæ—¶ï¼Œæ•°æ®ä»ç”¨æˆ·ç¨‹åºæ‹·è´åˆ°å†…æ ¸ç¼“å­˜ï¼Œå†ç”±å†…æ ¸ç¼“å­˜å†³å®šä»€ä¹ˆæ—¶å€™å†™å…¥æ•°æ®åˆ°ç£ç›˜ä¸­ã€‚

é˜»å¡I/Oï¼šå½“ç”¨æˆ·ç¨‹åºæ‰§è¡Œreadï¼Œçº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œä¸€ç›´ç­‰åˆ°å†…æ ¸æ•°æ®å‡†å¤‡å¥½ï¼Œå¹¶æŠŠæ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°åº”ç”¨ç¨‹åºçš„è¿˜å‡ºå»å»ï¼Œå½“æ‹·è´å®Œæˆåï¼Œreadæ‰è¿”å›ï¼Œé˜»å¡ç­‰å¾…çš„æ˜¯ã€å†…æ ¸æ•°æ®å‡†å¤‡å¥½ã€‘å’Œã€æ•°æ®ä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€ã€‘è¿™ä¸¤ä¸ªè¿‡ç¨‹ã€‚

éé˜»å¡I/Oï¼Œéé˜»å¡çš„readè¯·æ±‚åœ¨æ•°æ®æœªå‡†å¤‡å¥½çš„æƒ…å†µä¸‹ç«‹å³è¿”å›ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œæ­¤æ—¶åº”ç”¨ç¨‹åºä¸æ–­çš„è½®è¯¢å†…æ ¸ï¼Œç›´åˆ°æ•°æ®å‡†å¤‡å¥½ï¼Œå†…æ ¸å°†æ•°æ®æ‹·è´è‡³åº”ç”¨ç¨‹åºç¼“å†²åŒºï¼Œreadè°ƒç”¨æ‰è·å–åˆ°ç»“æœã€‚ä½†è¿™ç§æ–¹å¼éœ€è¦å‚»ä¹ä¹çš„ä¸æ–­è½®è¯¢æ•°æ®æ˜¯å¦å‡†å¤‡å¥½ï¼Œå› æ­¤å¤©æ‰çš„ç¨‹åºå‘˜å¼€å‘äº†I/Oå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå¦‚select,poll,epollï¼Œå®ƒæ˜¯é€šè¿‡I/Oäº‹ä»¶åˆ†å‘ï¼Œå½“å†…æ ¸æ•°æ®å‡†å¤‡å¥½æ—¶ï¼Œå†ä»¥äº‹ä»¶é€šçŸ¥åº”ç”¨ç¨‹åºè¿›è¡Œæ“ä½œã€‚ä»¥ä¸Šéƒ½æ˜¯åŒæ­¥è°ƒç”¨çš„ï¼Œè€ŒçœŸæ­£çš„å¼‚æ­¥I/Oæ˜¯ã€å†…æ ¸æ•°æ®å‡†å¤‡å¥½ã€‘å’Œã€æ•°æ®ä»å†…æ ¸æ€æ‹·è´åˆ°ç”¨æˆ·æ€ã€‘è¿™ä¸¤ä¸ªè¿‡ç¨‹éƒ½ä¸ç”¨ç­‰å¾…ï¼Œå‘èµ·aio_readä¹‹åï¼Œç«‹å³è¿”å›ï¼Œå†…æ ¸è‡ªåŠ¨å°†æ•°æ®ä»å†…æ ¸ç©ºé—´æ‹·è´åˆ°åº”ç”¨ç©ºé—´ï¼Œè¿™ä¸ªæ‹·è´æ˜¯è‡ªåŠ¨å®Œæˆçš„ã€‚

#### 3 V4L2æ‘„åƒå¤´é©±åŠ¨æ¡†æ¶

**è®¾å¤‡æ ‘**:æœ€æ–°çš„CPUåŠå…¶é©±åŠ¨å¼€å‘éƒ½æ˜¯åŸºäºè®¾å¤‡æ ‘çš„ï¼ŒV4L2æ¡†æ¶ä¹Ÿä¸ä¾‹å¤–

æè¿°è®¾å¤‡æ ‘çš„æ–‡ä»¶å«åšDTSï¼Œé‡‡ç”¨æ ‘å½¢ç»“æ„æè¿°æ¿çº§è®¾å¤‡ã€‚DTS\DTBå’ŒDTCçš„å…³ç³»ï¼šDTSæ˜¯è®¾å¤‡æ ‘çš„æºç æ–‡ä»¶ï¼ŒDTCå·¥å…·ç›¸å½“äºç¼–è¯‘å™¨ï¼Œå°†DTS--->DTBäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œï¼Œé€šè¿‡make dtbsç¼–è¯‘æ‰€æœ‰çš„DTSæ–‡ä»¶ï¼Œmake xxxx.dtbç¼–è¯‘æŸä¸ªDTSæ–‡ä»¶ã€‚

**DTSè¯­æ³•ï¼š**è®¾å¤‡æ ‘ä¹Ÿæ”¯æŒå¤´æ–‡ä»¶åŒ…å«ï¼Œå¤´æ–‡ä»¶çš„æ‰©å±•åä¸º.dtsi

```Device Tree
/dts-v1/
#include<xxx/input.h>
#include"imx6ull.dtsi"
/ {  /* /:æ ¹èŠ‚ç‚¹ */
    model = "xxxx";
    compatible = "xxxxx";
    chosen {
    	stdout-path = &uart1;
	};
	aliases {
	};
    memory {
	};
    backlight {
	};
    pxp_v4l2 {
	};
	intc:interrupt-controller@00a01000 { 
			/*intc:èŠ‚ç‚¹æ ‡ç­¾ï¼Œinterxxxller:èŠ‚ç‚¹åå­—ï¼Œ00a01000èŠ‚ç‚¹å¯„å­˜å™¨çš„èµ·å§‹åœ°å€*/
	};
    xxxxxxx
};
&cpu0 {  /* &label è¿½åŠ å±æ€§ */
};
xxxxxxx
```

å†…æ ¸å¯åŠ¨æ—¶ä¼šè§£æè®¾å¤‡æ ‘ï¼Œls /proc/device-tree/æŸ¥çœ‹æ‰€æœ‰çš„è®¾å¤‡æ ‘èŠ‚ç‚¹

è¿™äº›å­èŠ‚ç‚¹å°±æ˜¯æè¿°å¤–è®¾ç›¸å…³æ•°æ®çš„,å…¶ä¸­æœ‰ä¸¤ä¸ªç‰¹æ®ŠèŠ‚ç‚¹ï¼Œaliaseså®šä¹‰åˆ«åï¼Œä¸ºäº†æ–¹ä¾¿è®¿é—®èŠ‚ç‚¹ï¼Œchosenï¼šubooté‡Œé¢çš„bootargsç¯å¢ƒå˜é‡å€¼ï¼Œä¼ é€’ç»™Linuxå†…æ ¸ä½œä¸ºå‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™æ˜¯å› ä¸ºubootä¸­çš„fdt_chosenå‡½æ•°ä¼šæŸ¥æ‰¾choseèŠ‚ç‚¹ï¼Œæ·»åŠ bootargså±æ€§ï¼Œç‰¹æ®Šçš„å±æ€§ï¼Œcompatibleå±æ€§ï¼Œå€¼æ˜¯å­—ç¬¦ä¸²ï¼Œæ ¼å¼ï¼š"manufacturer,model",....ï¼Œmodelå±æ€§ï¼Œæè¿°æ¨¡å—ä¿¡æ¯ï¼Œstatuså±æ€§ï¼Œå–å€¼ï¼š"disabled","okey",#address-cellså’Œ#size-cellså±æ€§ï¼šä»£è¡¨å­èŠ‚ç‚¹åœ°å€æ‰€å çš„å­—é•¿å’Œé•¿åº¦æ‰€å çš„å­—é•¿ï¼Œregå±æ€§ï¼šï¼ˆaddress,lengthï¼‰å¤§éƒ¨åˆ†æè¿°è®¾å¤‡èµ·å§‹åœ°å€é•¿åº¦ï¼Œrangeså±æ€§ï¼šä½œåœ°å€æ˜ å°„.æ ¹èŠ‚ç‚¹çš„compatibleå±æ€§ï¼šå’ŒLinuxå†…æ ¸åŒ¹é…ï¼Œæ˜¯å¦æ”¯æŒè¿™ä¸ªè®¾å¤‡ã€‚äº†è§£å¸¸ç”¨çš„ofæ“ä½œå‡½æ•°ï¼Œè·å–åˆ°dtsä¸­èŠ‚ç‚¹å±æ€§çš„å€¼ï¼Œç»™åˆ°æ“ä½œç³»ç»Ÿã€‚

æœ€åLinuxä¼šè§£æDTBæ–‡ä»¶ï¼Œåœ¨ç›¸åº”çš„ç›®å½•ä¸‹ç”Ÿæˆç›¸åº”çš„è®¾å¤‡æ ‘èŠ‚ç‚¹æ–‡ä»¶ã€‚

å†…æ ¸è§£æå¹¶è·å–è®¾å¤‡æ ‘èŠ‚ç‚¹å±æ€§çš„å‡½æ•°æ˜¯ï¼šprobeå‡½æ•°ï¼Œè¯¥é©±åŠ¨æ–‡ä»¶ä¼šåŒ¹é…æŸä¸ªèŠ‚ç‚¹çš„compatibleå±æ€§ï¼Œçœ‹æ˜¯å¦ä¸æˆ‘çš„åŒ¹é…ï¼ŒåŒ¹é…äº†å°±è¿›è¡ŒèŠ‚ç‚¹å±æ€§çš„è·å–å¹¶è§£æã€‚è®¾ç½®å¥½è®¾å¤‡æ ‘æ–‡ä»¶åï¼Œå°±å¯ä»¥ä½¿ç”¨gpioå­ç³»ç»Ÿ...æä¾›çš„APIå‡½æ•°æ“ä½œæŒ‡å®šçš„GPIO.é©±åŠ¨æ¡†æ¶çš„ç¼–å†™ï¼š

```c
#include <linux/xxx.h>

/*gpioledè®¾å¤‡ç»“æ„ä½“*/
struct gpioled_dev{
    dev_t devid; //è®¾å¤‡å·
    struct cdev cdev; //cdevï¼Œè¡¨ç¤ºä¸€ä¸ªå­—ç¬¦è®¾å¤‡
    /*ç”¨äºè‡ªåŠ¨åˆ›å»ºè®¾å¤‡èŠ‚ç‚¹ çœå»mknodå‘½ä»¤*/
    struct class *class; //ç±»
    struct device *device; //è®¾å¤‡
    int major; //ä¸»è®¾å¤‡å·
    int minor; //æ¬¡è®¾å¤‡å·
    struct device_node *nd; //è®¾å¤‡èŠ‚ç‚¹
    int led_gpio;//ledæ‰€ä½¿ç”¨çš„GPIOç¼–å·
}
struct gpioled_dev gpioled; //ledè®¾å¤‡

/*è®¾å¤‡æ“ä½œå‡½æ•°é›†*/
static struct file_operations gpioled_fops = {
    .owner = THIS_MODLE,
    .open = led_open,
    .read = led_read,
    .write = led_write,
    .release = led_release,
}
static int __init led_init(void)
{
    int ret = 0;
    /*è®¾ç½®LEDæ‰€ä½¿ç”¨çš„GPIO*/
    /*1.ä»è®¾å¤‡æ ‘ä¸­è·å–è®¾å¤‡èŠ‚ç‚¹*/
    gpioled.nd = of_find_node_by_path("/gpioled"); //å¦‚ä½•éœ€è¦æ·»åŠ ä¸€ä¸ªledè®¾å¤‡é¦–å…ˆåº”åœ¨è®¾å¤‡æ ‘ä¸‹é…ç½®ç›¸åº”çš„å±æ€§ èŠ‚ç‚¹
    if(gpioled.nd == NULL){
        printk("gpioled node not find!\n\r");
        return -EINVAL;
	}else{
        printk("gpioled node find!\r\n");
	}
    /*2.è·å–è®¾å¤‡æ ‘ä¸­çš„gpioå±æ€§ ä½¿ç”¨of API*/
    gpioled.led_gpio = of_get_named_gpio(gpioled.nd, "led-gpio", 0);
    if(gpio.led_gpio < 0){
        printk("can't get led-gpio");
        return -EINVAL;
	}
    printk("led-gpio num = %d\r\n",gpio.led_gpio);
    /*3.ç”³è¯·IO æ£€æŸ¥GPIOæ˜¯å¦è¢«é‡å¤ä½¿ç”¨*/
    ret = gpio_request(gpiole.led_gpio, "led-gpio");
    if(ret){
        printk("Failed to request the led gpio\r\n");
        ret = -EINVAL;
        return ret;
	}
    /*4.è®¾ç½®GPIO1_IO03ä¸ºè¾“å‡ºï¼Œå¹¶ä¸”è¾“å‡ºé«˜ç”µå¹³ï¼Œé»˜è®¤å…³é—­led*/
    ret = gpio_direction_output(gpioled.led_gpio, 1);
    if(ret < 0){
        printk("cant set gpio!\r\n");
	}
    /*æ³¨å†Œå­—ç¬¦è®¾å¤‡é©±åŠ¨*/
    /*1.åˆ›å»ºè®¾å¤‡å·*/
    if(gpioled.major){ /*å®šä¹‰äº†è®¾å¤‡å·*/
        gpioled.devid = MKDEV(gpioled.major, 0);
        register_chrdev_region(gpioled.devid, GPIOLED_CNT, GPIOLED_NAME);
	}else{	//æ²¡æœ‰å®šä¹‰è®¾å¤‡å·
        alloc_chrdev_region(&gpioled.devid, 0, GPIOLED_CNT, GPIOLED_NAME);	/* ç”³è¯·è®¾å¤‡å· */
		gpioled.major = MAJOR(gpioled.devid);	/* è·å–åˆ†é…å·çš„ä¸»è®¾å¤‡å· */
		gpioled.minor = MINOR(gpioled.devid);	/* è·å–åˆ†é…å·çš„æ¬¡è®¾å¤‡å· */
	}
    printk("gpioled major=%d,minor=%d\r\n",gpioled.major, gpioled.minor);	
    /*2.åˆå§‹åŒ–cdev*/
    gpioled.cdev.owner = THIS_MODULE;
    cdev_init(&gpioled.cdev, &gpioled_fops);
    /*3.æ·»åŠ ä¸€ä¸ªcdev*/
	cdev_add(&gpioled.cdev, gpioled.devid, GPIOLED_CNT);
    /*4.åˆ›å»ºç±»*/
    gpioled.class = class_create(THIS_MODULE,GPIOLED_NAME);
    if (IS_ERR(gpioled.class)) {
		return PTR_ERR(gpioled.class);
	}
    /*5.åˆ›å»ºè®¾å¤‡*/
    gpioled.device = device_create(gpioled.class,NULL,gpioled.devid,NULL,GPIOLED_NAME);
    if (IS_ERR(gpioled.device)) {
		return PTR_ERR(gpioled.device);
	}
	return 0;
    
}
static void __exit led_exit(void)
{
    /*å…³ç¯ è°ƒç”¨GPIOå­ç³»ç»Ÿçš„APIå‡½æ•°*/
    gpio_set_value(gpio.led_gpio, 1);
    /* æ³¨é”€å­—ç¬¦è®¾å¤‡é©±åŠ¨ */
	cdev_del(&gpioled.cdev);/*  åˆ é™¤cdev */
	unregister_chrdev_region(gpioled.devid, GPIOLED_CNT); /* æ³¨é”€è®¾å¤‡å· */

	device_destroy(gpioled.class, gpioled.devid);
	class_destroy(gpioled.class);
    /*é‡Šæ”¾IO*/
    gpio_free(gpioled.led_gpio);
}

module_init(led_init) //é©±åŠ¨å…¥å£
module_exit(led_exit);//é©±åŠ¨å‡ºå£
MODULE_LICENSE("GPL");
MODULE_AUTHOR("cw");
```

æ€»ç»“ï¼š1.æ·»åŠ pinctrlä¿¡æ¯ 2.æ£€æŸ¥å½“å‰è®¾å¤‡è¦ä½¿ç”¨çš„IOæœ‰æ²¡æœ‰è¢«å…¶å®ƒè®¾å¤‡ä½¿ç”¨ï¼Œå¦‚æœæœ‰çš„è¯è¦å¤„ç† 3.æ·»åŠ è®¾å¤‡èŠ‚ç‚¹ï¼Œåœ¨è®¾å¤‡èŠ‚ç‚¹ä¸­åˆ›å»ºä¸€ä¸ªå±æ€§ï¼Œæ­¤å±æ€§æ‰€ä½¿ç”¨çš„gpio 4.ç¼–å†™é©±åŠ¨ï¼Œè·å–å¯¹åº”çš„gpioç¼–å·ï¼Œå¹¶ç”³è¯·IOï¼ŒæˆåŠŸå°±å¯ä»¥ä½¿ç”¨è¯¥IO pinctrlå­ç³»ç»Ÿä¸»è¦æ˜¯è®¾ç½®å¼•è„šçš„å¤ç”¨å’Œç”µæ°”å±æ€§çš„ï¼Œgpioå­ç³»ç»Ÿä¸»è¦æ˜¯è®¾ç½®IOçš„è¾“å…¥è¾“å‡ºçš„ã€‚

linux**çš„å¹¶å‘ä¸ç«äº‰**

å¤šä¸ªçº¿ç¨‹æ“ä½œå…±äº«èµ„æºæ—¶ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ•°æ®æ··ä¹±çš„é—®é¢˜ï¼Œlinuxæä¾›åŸå­æ•´å‹æ“ä½œAPIå‡½æ•°ï¼Œå…ˆå®šä¹‰åŸå­å˜é‡å¹¶åˆå§‹åŒ–ï¼šatomic_t a = ATOMIC_INIT(0);åŸå­æ“ä½œçš„APIå‡½æ•°ï¼švoid atomic_set(atomic_t *v, int i) ...ï¼›åŸå­ä½æ“ä½œï¼šç›´æ¥å¯¹påœ°å€è¿›è¡ŒåŸå­æ“ä½œï¼švoid clear_bit(int nr,void *p) ï¼›è¿™äº›åªæ˜¯é€‚ç”¨äºæ•´å‹å˜é‡å’Œä½ä¸´ç•Œèµ„æºçš„ä¿æŠ¤ï¼Œé¢å¯¹ç»“æ„ä½“åˆ™éœ€è¦ä»¥ä¸‹æ–¹å¼ã€‚

è‡ªæ—‹é”spinlock_tï¼šå½“è·å–ä¸åˆ°é”æ—¶ï¼Œä¼šä¸€ç›´å¾ªç¯ç­‰å¾…è¯¥é”çš„é‡Šæ”¾ï¼ŒCPUä½¿ç”¨çš„æ•ˆç‡å˜ä½ã€‚è¢«è‡ªæ—‹é”ä¿æŠ¤çš„ä¸´ç•ŒåŒºä¸€å®šä¸èƒ½è°ƒç”¨å¼•èµ·çº¿ç¨‹ä¼‘çœ å’Œé˜»å¡çš„APIå‡½æ•°ï¼Œå¦è€…ä¼šå‘ç”Ÿæ­»é”ç°è±¡ï¼Œä½¿ç”¨è‡ªæ—‹é”é»˜è®¤å…³é—­CPUæŠ¢å ã€‚å¯¹äºä¸­æ–­ï¼šå½“å—è‡ªæ—‹é”ä¿æŠ¤çš„ä¸´ç•ŒåŒºå—åˆ°ä¸­æ–­åï¼Œè¯¥ä¸­æ®µå‡½æ•°æŠ¢å äº†è¯¥CPUä½¿ç”¨æƒï¼Œä½†ä¹Ÿéœ€è¦ç­‰å¾…é”çš„é‡Šæ”¾å°±ä¹Ÿä¼šäº§ç”Ÿæ­»é”ã€‚è§£å†³åŠæ³•ä¹‹ä¸€ï¼Œè·å–é”ä¹‹å‰å¯ä»¥å…³é—­æœ¬åœ°ä¸­æ–­ã€‚

ä¿¡å·é‡seaphoreï¼šåˆ†ä¸ºè®¡æ•°å‹ä¿¡å·é‡å’ŒäºŒå€¼å‹ä¿¡å·é‡ï¼Œé€‚ç”¨äºä¸´ç•ŒåŒºè®¿é—®èµ„æºæ—¶é—´é•¿çš„åœºæ™¯ï¼Œå½“çº¿ç¨‹è·å–ä¸åˆ°ä¿¡å·é‡æ—¶ï¼Œä¼šè¿›å…¥ä¼‘çœ çŠ¶æ€ä»¥åä¼šåˆ‡æ¢çº¿ç¨‹ï¼Œä¸ç”¨å‚»ä¹ä¹çš„å ç€CPUå¾ªç¯ç­‰å¾…ã€‚

äº’æ–¥é”mutexï¼šç›¸å½“äºäºŒå€¼å‹ä¿¡å·é‡ï¼Œä¸èƒ½é€’å½’çš„è·å–äº’æ–¥é”ï¼Œä¹Ÿä¸èƒ½åœ¨ä¸­æ–­ä¸­ä½¿ç”¨ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„ä¸€ç§æ–¹å¼

Linuxå†…æ ¸å®šæ—¶å™¨çš„ä½¿ç”¨ï¼šå†…æ ¸å®šæ—¶å™¨å¹¶ä¸æ˜¯å‘¨æœŸæ€§çš„è¿è¡Œçš„ï¼Œè¶…æ—¶åå°±ä¼šè‡ªåŠ¨å…³é—­ï¼Œå› æ­¤è¦å®ç°å‘¨æœŸæ€§å®šæ—¶ï¼Œå°±éœ€è¦åœ¨å®šæ—¶å¤„ç†å‡½æ•°ä¸­é‡æ–°å¼€å¯å®šæ—¶å™¨ï¼Œvoid init_timer(struct timer_list *timer)åˆå§‹åŒ–å®šæ—¶å™¨ï¼Œint mod_timer(struct timer_list *timer, unsigned long expires)ä¿®æ”¹å®šæ—¶å™¨å€¼ï¼Œå¦‚æœæ²¡æœ‰æ¿€æ´»å°±æ¿€æ´»å®šæ—¶å™¨ï¼Œè¯¥å‡½æ•°å¯ä»¥åšåˆ°å‘¨æœŸæ€§çš„å®šæ—¶ï¼Œint del_timer(struct timer_list *timer)åˆ é™¤ä¸€ä¸ªå®šæ—¶å™¨ã€‚

Linuxä¸­æ–­çš„ä½¿ç”¨ï¼šä¸ŠåŠéƒ¨å’Œä¸‹åŠéƒ¨ï¼Œå°†è´¹æ—¶çš„ä»»åŠ¡æ”¾åœ¨è½¯ä¸­æ–­ä¸­çš„æœåŠ¡å‡½æ•°ä¸­ã€‚è£¸æœºä¸­ä¸­æ–­çš„å¤„ç†æµç¨‹æ˜¯ï¼šä½¿èƒ½ä¸­æ–­ï¼Œåˆå§‹åŒ–ç›¸åº”çš„å¯„å­˜å™¨ï¼Œæ³¨å†Œä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œåœ¨IRQä¸­æ–­æœåŠ¡å‡½æ•°åœ¨æ•°ç»„irqTableé‡ŒæŸ¥æ‰¾å…·ä½“çš„ä¸­æ–­æœåŠ¡å‡½æ•°ï¼Œè€ŒLinuxç³»ç»Ÿæé«˜äº†ä¸€å¥—æ„å»ºä¸­æ–­çš„apiå‡½æ•°ï¼Œä½¿ç”¨ä¸­æ–­å·åŒºåˆ†ä¸åŒçš„ä¸­æ–­ï¼Œint request_irq(unsigned int irq,irq_handler_t handler,unsigned long flags, const char *name, void *dev)ç”³è¯·ä¸€ä¸ªå¯ç”¨çš„ä¸­æ–­å·ï¼Œvoid free_irq(unsigned int irq, void *dev);é‡Šæ”¾ç›¸åº”çš„ä¸­æ–­å·ï¼Œä¸­æ–­å¤„ç†å‡½æ•°irqreturn_t(\*irq_handler_t)(int, void*)ã€‚

åº”ç”¨ç¨‹åºè®¿é—®è®¾å¤‡èµ„æºæ—¶ï¼Œæœ‰ä¸¤ç§æ–¹å¼ï¼šé˜»å¡å¼IOå’Œéé˜»å¡å¼IOï¼Œé˜»å¡è®¿é—®ï¼Œå¯ä»¥å½“è®¾å¤‡ä¸å¯æ“ä½œæ—¶è®©å‡ºCPUä½¿ç”¨æƒï¼Œè¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œå½“å¯ä»¥è®¿é—®æ—¶ï¼Œåœ¨ä¸­æ–­å‡½æ•°é‡Œé¢å”¤é†’è¯¥è¿›ç¨‹ï¼Œlinuxå†…æ ¸æä¾›äº†ç­‰å¾…é˜Ÿåˆ—æ¥å®ç°é˜»å¡è¿›ç¨‹çš„å”¤é†’å·¥ä½œï¼Œåˆå§‹åŒ–ç­‰å¾…é˜Ÿåˆ—å¤´:void init_waitqueue_head(wait_queue_head_t *q)ä¹Ÿä½¿ç”¨å®DECLARE_WAIT_QUEUE_HEADç­‰å¾…é˜Ÿåˆ—å¤´çš„å®šä¹‰å’Œåˆå§‹åŒ–ï¼Œå®šä¹‰å¹¶åˆå§‹åŒ–ç­‰å¾…é˜Ÿåˆ—é¡¹DECLARE_WAITQUEUE(name,tsk)ï¼Œadd_wait_queue(q, wait)å‘ç­‰å¾…é˜Ÿåˆ—å¤´qæ·»åŠ ç­‰å¾…é˜Ÿåˆ—é¡¹ï¼Œremove_wait_queue(q,wait)ä¸ä¹‹ç›¸åï¼Œwake_up(q)å”¤é†’æ‰€æœ‰çš„ç­‰å¾…é˜Ÿåˆ—å¤´é‡Œçš„è¿›ç¨‹ã€‚éé˜»å¡è®¿é—®ï¼Œå°±éœ€è¦è®¾å¤‡é©±åŠ¨ç¨‹åºæä¾›è½®è¯¢ï¼Œselect,poll,epollå¤„ç†è½®è¯¢ï¼Œå¯¹åº”è®¾å¤‡é©±åŠ¨pollå‡½æ•°å°±ä¼šæ‰§è¡Œï¼Œï¼Œunsigned int (\*poll)(struct file *filp,struct poll_table_struct *wait)ã€‚

å¼‚æ­¥IOï¼šé€šè¿‡"ä¿¡å·"å®ç°ï¼Œä¿¡å·æ˜¯ä¸€ç§è½¯ä»¶æ¨¡æ‹Ÿç¡¬ä»¶ä¸­æ–­çš„ä¸€ç§æœºåˆ¶ã€‚é©±åŠ¨ç¨‹åºçš„å®ç°ï¼šå®šä¹‰fasync_structç»“æ„ä½“ï¼Œä½¿ç”¨å¼‚æ­¥é€šçŸ¥åŠŸèƒ½è¿˜éœ€è¦åœ¨è®¾å¤‡é©±åŠ¨ä¸­å®ç°file_operationsæ“ä½œé›†ä¸­çš„fasyncå‡½æ•°ï¼Œé‡Œé¢è°ƒç”¨fasync_helperå‡½æ•°æ¥åˆå§‹åŒ–fasync_structç»“æ„ä½“ï¼Œåœ¨æ»¡è¶³æ¡ä»¶æ—¶è°ƒç”¨void kill_fasync(struct fasync_struct **fp, int sig, int band)å‡½æ•°å‘åº”ç”¨ç¨‹åºå‘å‡ºä¿¡å·ã€‚åº”ç”¨ç¨‹åºçš„å®ç°ï¼šæ³¨å†Œä¿¡å·å¤„ç†å‡½æ•°signal(SIGIO, func),å¼€å¯å¼‚æ­¥é€šçŸ¥ã€‚

##### 3.1 platformè®¾å¤‡é©±åŠ¨

é©±åŠ¨çš„åˆ†ç¦»å’Œåˆ†å±‚ï¼šé©±åŠ¨ç¨‹åºç§»æ¤åˆ°å¦ä¸€ä¸ªå¹³å°ä¸Šéš¾åº¦å¤§ï¼Œå¯é‡ç”¨æ€§å·®ï¼Œå› æ­¤linuxå°†é©±åŠ¨åˆ†ä¸ºä¸»æœºé©±åŠ¨å’Œè®¾å¤‡é©±åŠ¨ï¼Œä¸­é—´ä½¿ç”¨ç»Ÿä¸€çš„APIæ¥å£ã€‚é©±åŠ¨åˆ†å±‚çš„ç›®çš„æ˜¯ä¸ºäº†åœ¨ä¸åŒçš„å±‚å¤„ç†ä¸åŒçš„å†…å®¹ï¼Œä¾‹å¦‚inputå­ç³»ç»Ÿä¼šç®¡ç†æ‰€æœ‰å’Œè¾“å…¥æœ‰å…³çš„é©±åŠ¨ï¼Œè·å–è¾“å…¥è®¾å¤‡çš„åŸå§‹å€¼ï¼Œä¸ŠæŠ¥ç»™inputæ ¸å¿ƒå±‚ï¼Œæ ¸å¿ƒå±‚å°±ä¼šå¤„ç†å„ç§IOæ¨¡å‹ï¼Œæä¾›file_operationsæ“ä½œé›†åˆï¼Œç¼–å†™è¾“å…¥è®¾å¤‡é©±åŠ¨çš„æ—¶å€™å°±åªéœ€è¦å¤„ç†å¥½è¾“å…¥äº‹ä»¶çš„ä¸ŠæŠ¥å³å¯ã€‚

è®¾å¤‡-æ€»çº¿-é©±åŠ¨ æ¡†æ¶ï¼š

platformæ€»çº¿ï¼šLinuxå†…æ ¸ä½¿ç”¨bus_typeç»“æ„ä½“è¡¨ç¤ºæ€»çº¿

platformé©±åŠ¨ï¼šplatform_driverç»“æ„ä½“è¡¨ç¤ºplatformé©±åŠ¨,ç»§æ‰¿è‡³device_driverç»“æ„ä½“

platformè®¾å¤‡ï¼šplatform_deviceç»“æ„ä½“æ ‡è¯†platformè®¾å¤‡ï¼Œå¦‚æœä½¿ç”¨äº†è®¾å¤‡æ ‘ï¼Œå°±ä¸å†ä½¿ç”¨è¯¥ç»“æ„ä½“æè¿°è®¾å¤‡äº†

é©±åŠ¨å’Œè®¾å¤‡çš„åŒ¹é…æ–¹å¼æœ‰å››ç§ï¼ŒOFç±»å‹åŒ¹é…ï¼ˆè®¾å¤‡æ ‘åŒ¹é…æ–¹å¼ï¼‰of_match_tableæˆå‘˜å˜é‡ä¿å­˜ç€é©±åŠ¨çš„compatibleåŒ¹é…è¡¨ï¼Œè¯¥è¡¨å’Œè®¾å¤‡æ ‘èŠ‚ç‚¹çš„compatibleå±æ€§åŒ¹é…ï¼›ACPIåŒ¹é…æ–¹å¼ï¼›id_tableåŒ¹é…æ–¹å¼ï¼›nameå­—æ®µåŒ¹é…æ–¹å¼ã€‚

```c
...
/*platformé©±åŠ¨çš„probeå‡½æ•° å½“è®¾å¤‡åŒ¹é…åå°±ä¼šæ‰§è¡Œ*/
static int led_probe(struct platform_device *dev)
{
	...
}
/*platformé©±åŠ¨çš„removeå‡½æ•°ï¼Œç§»é™¤platformé©±åŠ¨æ—¶ä¼šæ‰§è¡Œ*/
static int led_remove(struct platform_device *dev)
{
	...
}

/*åŒ¹é…åˆ—è¡¨*/
static const struct of_device_id_led_of_match[] = {
	{.compatible = "gpioleds"}.
	{/*Sentinel*/}
};
/*platformé©±åŠ¨ç»“æ„ä½“*/
static struct platform_driver led_driver = {
	.driver = {
		.name = "imx6ul-led"ï¼› //é©±åŠ¨åå­—
		.of_match_table = led_of_match, //è®¾å¤‡æ ‘åŒ¹é…è¡¨
	}
	.probe = led_probe,
	.remove = led_remove,
}
//é©±åŠ¨å…¥å£
static int __init leddriver_init(void)
{
	return platform_driver_register(&led_driver);
}
//é©±åŠ¨å‡ºå£
static void __exit leddriver_exit(void)
{
	platform_driver_unregister(&led_driver);
}
modeule_init(leddriver_init);
module_exit(leddriver_exit);
MODULE_LICENSE("GPL");
MODULE_AUTHOR("CW");
```

##### 3.2 v4l2åº”ç”¨ç¨‹åºæ¡†æ¶

ä¸»è¦ä½¿ç”¨ioctlå‡½æ•°æ¥å¯¹æ‘„åƒå¤´é©±åŠ¨æ§åˆ¶ã€‚

USBæ‘„åƒå¤´å†…éƒ¨ç»“æ„ï¼šè§†é¢‘æ§åˆ¶æ¥å£å’Œä¼ è¾“æ¥å£ï¼ŒCTæ‘„åƒå¤´ç»ˆç«¯ï¼ŒITè¾“å…¥ç»ˆç«¯ï¼ŒSUé€‰æ‹©å•å…ƒï¼ŒPUå¤„ç†å•å…ƒï¼ŒOTè¾“å…¥ç»ˆç«¯ã€‚

æ€ä¹ˆå†™ä¸€ä¸ªUSBæ‘„åƒå¤´é©±åŠ¨ï¼Ÿ

1. æ„é€ ä¸€ä¸ªusb_driver

2. è®¾ç½®probeï¼š

   2.1 åˆ†é…video_device:video_device_alloc

   2.2 è®¾ç½® .fops  .ioctl_ops å¦‚æœè¦ç”¨åˆ°å†…æ ¸æä¾›çš„ç¼“å†²åŒºæ“ä½œå‡½æ•°ï¼Œè¿˜éœ€è¦æ„é€ ä¸€ä¸ªvideobuf_queue_ops

   2.3 æ³¨å†Œï¼švideo_register_device

   â€‹		id_table:å’Œè®¾å¤‡æ ‘çš„USBæ‘„åƒå¤´è¿›è¡ŒåŒ¹é…

3. æ³¨å†Œï¼šusb_register

uvc_driver.cé©±åŠ¨åˆ†æ

1.usb_register(&uvc_driver.driver);

2.uvc_probe

3.é€šè¿‡videoControl Interfaceæ¥æ§åˆ¶ï¼Œé€šè¿‡VideoStreaming Interfaceæ¥è¯»å–è§†é¢‘æ•°æ®

VCé‡Œå«æœ‰å¤šä¸ªUnit/Terminalç­‰åŠŸèƒ½æ¨¡å—ï¼Œå¯ä»¥é€šè¿‡è®¿é—®è¿™äº›æ¨¡å—è¿›è¡Œæ§åˆ¶ï¼Œæ¯”å¦‚è°ƒèŠ‚äº®åº¦

åˆ†æUVCé©±åŠ¨è°ƒç”¨è¿‡ç¨‹ ioctlçš„cmdå‘½ä»¤

```c
const struct v4l2_file_operations uvc_fops = {
	.owner = THIS_MODULE,
	.open = uvc_v4l2_open,
	.release = uvc_v4l2_release,
	.ioctl = uvc_v4l2_ioctl,
	.read = uvc_v4l2_read,
	.mmap = uvc_v4l2_mmap,
	.poll = uvc_v4l2_poll,
}
```

1.open:è°ƒç”¨uvc_v4l2_open

2.VIDIOC_QUERYCAP //video->streaming->typeæ˜¯åœ¨è®¾å¤‡è¢«æšä¸¾æ—¶åˆ†ææè¿°ç¬¦æ—¶è®¾ç½®çš„

```C
if(video->streaming->type == V4L2_BUF_TYPE_VIDEO_CAPTURE)
	cap->capabilities = V4L2_CAP_VIDEO_CAPTURE | V4L2_CAP_STREAMING;
else
	cap->capabilities = V4L2_CAP_VIDEO_OUTPUT | V4L2_CAP_STREAMING;
```

3.VIDIOC_ENUM_FMT //formatæ•°ç»„åº”åœ¨è®¾å¤‡è¢«æšä¸¾æ—¶è®¾ç½®çš„

```c
format = &video->streaming->format[fmt->index];
```

4.VIDIOC_G_FMT //uvc_v4l2_get_format æ ¼å¼

```c
struct uvc_format *format = video->streaming->cur_format;
struct uvc_fram *frame = video->steaming->cur_frame;
```

5.VIDIO_TRY_FMT //è·å–æ ¼å¼å‰æ£€æŸ¥æ˜¯å¦æ”¯æŒè¯¥æ ¼å¼

6.VUDIOC_S_FMT	//è®¾ç½®æ ¼å¼

7.VIDIO_REQBUFS //ç”³è¯·è§†é¢‘ç¼“å†²åŒºbuffer

8.VIDIOC_QUERYBUF //æŸ¥è¯¢æ¯ä¸ªç¼“å†²åŒºçš„bufferä¿¡æ¯

9.mmap //å†…å­˜bufferæ˜ å°„

10.VIDIOC_QBUF //å°†å‡†å¤‡å¥½çš„è§†é¢‘ç¼“å†²åŒºbufferå…¥é˜Ÿåˆ°ç©ºé—²é“¾è¡¨

11.VIDIOC_STREAMON //å¼€å¯USBæ‘„åƒå¤´

12.poll //ä¼‘çœ ç­‰å¾…æœ‰æ•°æ®(whileè½®è¯¢)

13.VIDIOC_DQBUF //å–å‡ºé˜Ÿåˆ—ä¸­çš„buffer

14.VISIOC_STREAMOFF //å…³é—­æ‘„åƒå¤´

>æ€»ç»“: å±æ€§çš„æ§åˆ¶,æ ¼å¼çš„é€‰æ‹©,æ•°æ®çš„è·å¾—
>
>1.UVCè®¾å¤‡2ä¸ªæ¥å£:VideoControl Interface,VideoSteaming Interface
>
>2.VC Iç”¨äºæ§åˆ¶,æ¯”å¦‚è®¾ç½®äº®åº¦.å®ƒå†…éƒ¨æœ‰å¤šä¸ªUnit/Terminal(entityå®ä½“)
>
>3.VS Iç”¨äºè·å¾—è§†é¢‘æ•°æ®,ä¹Ÿå¯ä»¥ç”¨æ¥é€‰æ‹©format/frame

YUVæ ¼å¼è½¬RGBæ ¼å¼å¹¶ç¼©æ”¾åˆ°LCDä¸Š

>YUVæ ¼å¼:Y:æ˜äº®åº¦,U,Vè¡¨ç¤ºè‰²åº¦,YUV4:2:0ä¸­çš„420ä»£è¡¨YUVçš„é‡‡æ ·ç‡

```
//YUV420 -> RGB888
void YUVImage::yuv2rgb(uint8_t yValue, uint8_t uValue, uint8_t vValue,
        uint8_t *r, uint8_t *g, uint8_t *b) const {
    *r = yValue + (1.370705 * (vValue-128));
    *g = yValue - (0.698001 * (vValue-128)) - (0.337633 * (uValue-128));
    *b = yValue + (1.732446 * (uValue-128));
    *r = clamp(*r, 0, 255);
    *g = clamp(*g, 0, 255);
    *b = clamp(*b, 0, 255);
}
```

#### 4 yolov5æ¨¡å‹çš„é‡åŒ–å’Œå‰ªæ

##### 4.1 yolov5éƒ¨ç½²åœ¨RV126è®¾å¤‡ä¸Šç®€å•æµç¨‹

>å‡†å¤‡æ•°æ®é›†,è°ƒå‚,è®­ç»ƒå¾—åˆ°.ptæ¨¡å‹æ–‡ä»¶

yolov5å®˜æ–¹ä»£ç : [ultralytics/yolov5: YOLOv5 ğŸš€ in PyTorch > ONNX > CoreML > TFLite (github.com)](https://github.com/ultralytics/yolov5)

>ptæ¨¡å‹è½¬ä¸ºonnxä¸­é—´æ ¼å¼æ¨¡å‹

```python
python3 models/export.py --weights "xxx.pt"
```

>onnxæ¨¡å‹è½¬ä¸ºrknnæ¨¡å‹

onnxæ¨¡å‹è¿˜éœ€è¦è½¬æ¢ä¸ºrknnæ¨¡å‹æ‰èƒ½åœ¨RV1126è®¾å¤‡ä¸ŠåŠ è½½,æ‰€ä»¥éœ€è¦å…ˆæ­å»ºrknn-tookitæ¨¡å‹è½¬æ¢å·¥å…·ç¯å¢ƒ:https://github.com/rockchip-linux/rknn-toolkitä¸­çš„rknn_convert.pyè„šæœ¬

>æ¨¡å‹é¢„ç¼–è¯‘

NPU APIåŠ è½½rknnæ¨¡å‹é€Ÿåº¦ææ…¢,åœ¨è¯„ä¼°å®Œæ¨¡å‹ç²¾åº¦æ²¡é—®é¢˜ä¹‹å,å¯ä»¥è¿›è¡Œæ¨¡å‹é¢„ç¼–è¯‘.è¿è¡Œprecompile_rknn.pyè„šæœ¬æ–‡ä»¶,å°†æ¨¡å‹é¢„ç¼–è¯‘ç”Ÿæˆé¢„ç¼–è¯‘åçš„æ¨¡å‹æ–‡ä»¶precompile.rknn

>æ¨¡å‹åŠ è½½å’Œæ¨ç†

```c
/*ç®—æ³•æ¨¡å‹åˆå§‹åŒ–*/
yolov5_detect_init(&ctx, "best.rknn");
/*æ¨¡å‹æ¨ç†*/
yolov5_detect_run(ctx, rgb_img, &detect_result_group);
```

##### 4.2 é‡åŒ–,å‰ªæå’Œè’¸é¦

>é‡åŒ–æ˜¯ä¸€ç§é€šè¿‡å‡å°‘æ¨¡å‹å‚æ•°çš„ä½æ•°æ¥é™ä½æ¨¡å‹è®¡ç®—é‡å’Œå†…å­˜æ¶ˆè€—çš„æŠ€æœ¯,æ·±åº¦å­¦ä¹ ä¸€ä¸ªå‚æ•°é€šå¸¸ä½¿ç”¨32ä½æµ®ç‚¹æ•°æ¥è¡¨ç¤º,å®é™…æ¨ç†ä¸­,ä¸éœ€è¦è¿™ä¹ˆé«˜ç²¾åº¦çš„å‚æ•°è¡¨ç¤º
>
>å‰ªææ˜¯ä¸€ç§åˆ é™¤æ¨¡å‹ä¸­ä¸é‡è¦çš„å‚æ•°å’Œè¿æ¥æ¥å‡å°‘æ¨¡å‹å‚æ•°æ•°é‡å’Œè®¡ç®—é‡çš„æŠ€æœ¯,å‰ªæç®—æ³•ä¼šè¯†åˆ«å“ªäº›å¯¹æ¨¡å‹è´¡çŒ®è¾ƒå°‘çš„å‚æ•°,å°†å…¶å‰ªææ‰
>
>è’¸é¦æ˜¯ä¸€ç§å°†å¤§å‹æ¨¡å‹çš„çŸ¥è¯†è½¬ç§»ç»™å°å‹æ¨¡å‹çš„ä¸€ç§æŠ€æœ¯

é‡åŒ–çš„å®è´¨å°±æ˜¯å°†æ¨¡å‹å‚æ•°çš„å­˜å‚¨ç±»å‹ä»é«˜ç²¾åº¦å­˜å‚¨é™ä½åˆ°ä½ç²¾åº¦å­˜å‚¨,ä»è€Œè¾¾åˆ°å‡å°‘æ¨¡å‹ä½“ç§¯å¤§å°,åŠ å¿«æ¨¡å‹æ¨ç†é€Ÿåº¦çš„æ•ˆæœ,ä½¿ç”¨yolov5è‡ªå¸¦çš„export.pyå‡½æ•°

FP32é‡åŒ–(é»˜è®¤32ä½)

```
python export.py --weights xxx/best.pt --include onnx engine --device 0
```

FP16é‡åŒ–

```
python export.py --weights xxx/best.pt --include onnx engine --half --device 0
```

> æ¨¡å‹å¤§å°å‡å°‘å¤§çº¦ä¸€åŠ,æ¨ç†é€Ÿåº¦ä»4.9msæé«˜åˆ°äº†2.3ms

INT8é‡åŒ–

ä½¿ç”¨export.pyå‡½æ•°å¯¼å‡ºçš„æ•ˆæœå¹¶ä¸å¥½,ä¸æ¨è

**å‰ªæ**

å¯¹äºå¤æ‚çš„ç½‘ç»œæ¨¡å‹ç»“æ„,è™½ç„¶åœ¨GPUè¿™ç§é«˜ç®—åŠ›ä¸‹é€Ÿåº¦å’Œç²¾ç¡®åº¦è¡¨ç°éƒ½ä¼˜ç§€,ä½†æ˜¯æ¨¡å‹ä¹Ÿæœ‰å¯èƒ½éƒ¨ç½²åœ¨èµ„æºå—é™çš„åµŒå…¥å¼CPUæˆ–è€…NUPä¸Š,è¿™ç§ç®—åŠ›å¾€å¾€è¾ƒä½,å°½ç®¡å¯ä»¥å°†æ¨¡å‹é‡åŒ–,å¯ä»¥å¤§å¤§é™ä½è®¡ç®—é‡,ä½†æ˜¯åªé è¿™ç§æ–¹å¼æ˜¯ä¸å¤Ÿçš„,è¿˜æœ‰ä¸€ç§æ–¹å¼ä»ç½‘ç»œç»“æ„å’Œå‚æ•°å…¥æ‰‹,è¿›è¡Œæ¨¡å‹çš„è£å‰ª,æ¯”å¦‚å‡å°‘é€šé“æ•°æˆ–æ¨¡å‹çš„æ·±åº¦,ä½†è¿™ç§æ–¹å¼æ˜¯ä»¥ç‰ºç‰²æ¨¡å‹ç²¾åº¦ä¸ºä»£ä»·çš„...å‰ªæå°±æ˜¯ä¸€ç§ä½¿ç”¨æ¯”è¾ƒå¹¿æ³›çš„æ¨¡å‹è½»é‡åŒ–æ–¹æ³•

æ¨¡å‹å‰ªææ˜¯ä¸€ç§é€šè¿‡å‡å°‘ç¥ç»ç½‘ç»œæ¨¡å‹ä¸­çš„å†—ä½™å‚æ•°å’Œè¿æ¥æ¥ä¼˜åŒ–æ¨¡å‹çš„ä¸€ç§æ–¹å¼,æ—¨åœ¨å‡å°‘æ¨¡å‹çš„å¤§å°,å†…å­˜å ç”¨å’Œè®¡ç®—å¤æ‚åº¦,åŒæ—¶å°½å¯èƒ½ä¿æŒæ¨¡å‹ç²¾åº¦(è¦æƒ³ä¸æŸå¤±ç‚¹ç²¾åº¦æ˜¯ä¸å¯èƒ½çš„)

>æ¨¡å‹å‰ªææ–¹æ³•:[Learning Efficient Convolutional Networks Through Network Slimming (thecvf.com)](https://openaccess.thecvf.com/content_ICCV_2017/papers/Liu_Learning_Efficient_Convolutional_ICCV_2017_paper.pdf)
>
>å‰ªææºä»£ç :[https://github.com/foolwood/pytorch-slimming](https://github.com/foolwood/pytorch-slimming)

æŒ‰æ¯”ä¾‹å‰ªæ,å¦‚å‰ªææ¯”ä¾‹0.5

    python prune.py --cfg models/yolov5s_voc.yaml --weights runs/exp7_sl-2e-3-yolov5s/weights/last.pt --save-dir runs/exp7_sl-2e-3-yolov5s/weights/ --prob 0.5

æŒ‰æƒé‡å¤§å°å‰ªæ,æ¯”å¦‚å°äº0.01æƒé‡çš„é€šé“å‰ª

```
python prune.py --cfg models/yolov5s_voc.yaml --weights runs/exp7_sl-2e-3-yolov5s/weights/last.pt --save-dir runs/exp7_sl-2e-3-yolov5s/weights/ --thres 0.01
```

å¾€å¾€æ˜¯8çš„å€æ•°æ—¶,ç¥ç»ç½‘ç»œæ¨ç†è¾ƒå¿«

```
python prune.py --cfg models/yolov5s_voc.yaml --weights runs/exp7_sl-2e-3-yolov5s/weights/last.pt --save-dir runs/exp7_sl-2e-3-yolov5s/weights/ --thres 0.01 --rate 8
```

æŒ‰é€šé“å‰ªæ

è®­ç»ƒåŸå§‹æ¨¡å‹--->è®¡ç®—é€šé“çš„é‡è¦æ€§

- æƒé‡L1èŒƒæ•°:è®¡ç®—æ¯ä¸ªé€šé“æƒé‡çš„L1èŒƒæ•°,å¹¶é€‰æ‹©L1èŒƒæ•°è¾ƒå°çš„é€šé“è¿›è¡Œå‰ªæ
- è¾“å‡ºçš„å¹³å‡æ¿€æ´»å€¼:è®¡ç®—æ¯ä¸ªé€šé“åœ¨è®­ç»ƒæ•°æ®ä¸Šçš„å¹³å‡æ¿€æ´»å€¼,å¹¶é€‰æ‹©å¹³å‡æ¿€æ´»è‡³è¾ƒå°çš„é€šé“è¿›è¡Œå‰ªæ
- æ¢¯åº¦çš„L2èŒƒæ•°:è®¡ç®—æ¯ä¸ªé€šé“çš„æ¢¯åº¦L2èŒƒæ•°,å¹¶é€‰æ‹©L2èŒƒæ•°è¾ƒå°çš„é€šé“è¿›è¡Œå‰ªæ

**çŸ¥è¯†è’¸é¦**

çŸ¥è¯†è’¸é¦æ˜¯åœ¨ä¸€ä¸ªé«˜ç²¾åº¦çš„å¤§æ¨¡å‹å’Œä¸€ä¸ªä½ç²¾åº¦çš„å°æ¨¡å‹ä¹‹é—´å»ºç«‹æŸå¤±å‡½æ•°ï¼Œä¹Ÿå¯ä»¥åœ¨å°æ¨¡å‹å’ŒåŸæ•°æ®æ ·æœ¬ä¹‹é—´å»ºç«‹æŸå¤±å‡½æ•°ã€‚è¿™ä¸ªå¤§æ¨¡å‹å«åšæ•™å¸ˆç½‘ç»œï¼Œå°æ¨¡å‹å«åšå­¦ç”Ÿç½‘ç»œï¼›æ•™å¸ˆæ¨¡å‹å¼•å¯¼å­¦ç”Ÿæ¨¡å‹è¿›è¡Œå­¦ä¹ ï¼Œä¹Ÿå°±æ˜¯å®ƒä»¬ä¹‹é—´å»ºç«‹ä¸€ä¸ªè½¯æ ‡ç­¾ä¸‹çš„æŸå¤±å‡½æ•°

åŸå§‹çš„softmaxå…¬å¼ï¼š

![image-20240521231218585](README.assets/image-20240521231218585.png)

å¼•å…¥äº†æ¸©åº¦å˜é‡Tçš„softmaxå…¬å¼ï¼š

![image-20240521231309078](README.assets/image-20240521231309078.png)

è¿™æ ·å°±å¯ä»¥å°†è¾“å‡ºçš„ç¡¬æ ‡ç­¾[0,1,0,0]è½¬ä¸ºå¯Œå«æ›´å¤šä¿¡æ¯çš„è½¯æ ‡ç­¾[0.1,0.8,0.05.0.05]è¿›è¡ŒæŸå¤±å‡½æ•°çš„è®¡ç®—ã€‚

>è¯¥Tæ¸©åº¦å€¼é«˜ä½æ”¹å˜æ—¶å­¦ç”Ÿæ¨¡å‹è®­ç»ƒè¿‡ç¨‹ä¸­å¯¹è´Ÿæ ‡ç­¾çš„å…³æ³¨ç¨‹åº¦.Tè¶Šå°ï¼Œå¯¹è´Ÿæ ‡ç­¾å…³æ³¨ä¹Ÿè¶Šå°



![zhengliu](README.assets/zhengliu.png)

å¦‚ä¸Šå›¾ï¼ŒTåªç”¨ä½œç”¨äºæ•™å¸ˆç½‘ç»œå’Œå­¦ç”Ÿç½‘ç»œçš„è’¸é¦è¿‡ç¨‹ï¼Œå­¦ç”Ÿç½‘ç»œå’ŒçœŸå®æ•°æ®æ ‡ç­¾çš„Tå–å€¼ä¸º1

è¿™æ ·ï¼Œå°±å¾—åˆ°äº†ä¸¤ä¸ªæŸå¤±å€¼distillation losså’Œstudent lossï¼Œè®­ç»ƒçš„æ•´ä½“æŸå¤±ï¼Œå°±æ˜¯è¿™ä¸ªæŸå¤±å€¼çš„åŠ æƒå’Œï¼š

![loss](README.assets/loss.png)

ç»è¿‡è’¸é¦ä¹‹åçš„æ¨¡å‹ï¼Œä¸ä»…æ¨¡å‹å¤§å°å˜å°äº†ï¼Œæ¨¡å‹çš„ç²¾ç¡®åº¦ä¹Ÿæœ‰æ‰€ä¸Šå‡ã€‚

YOLOv5**çŸ¥è¯†è’¸é¦**

>å‚è€ƒä»£ç ï¼šhttps://github.com/Adlik/yolov5

ä¿®æ”¹train.pyæ–‡ä»¶å¾—åˆ°train_distillation.py

```python
parser.add_argument('--t_weights', type=str, default='./weights/yolov5s.pt',
                        help='initial teacher model weights path')
parser.add_argument('--t_cfg', type=str, default='models/yolov5s.yaml', help='teacher model.yaml path')
parser.add_argument('--d_output', action='store_true', default=False,
                    help='if true, only distill outputs')
parser.add_argument('--d_feature', action='store_true', default=False,
                    help='if true, distill both feature and output layers')
```

t_weights ï¼šæ•™å¸ˆæ¨¡å‹æƒé‡åŠ è½½è·¯å¾„

t_cfgï¼šæ•™å¸ˆæ¨¡å‹é…ç½®ï¼Œå’Œå­¦ç”Ÿæ¨¡å‹é…ç½®ç±»ä¼¼

d_featureï¼šé»˜è®¤å…³é—­
